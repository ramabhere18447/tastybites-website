<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - TastyBite</title>

  <!-- Favicon -->
  <link
    rel="icon"
    type="image/png"
    href="https://cdn-icons-png.flaticon.com/512/1404/1404945.png"
  />

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-danger">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <img
          src="https://cdn-icons-png.flaticon.com/512/1404/1404945.png"
          width="28"
          height="28"
          alt="logo"
        />
        TastyBite
      </a>
    </div>
  </nav>

  <!-- Checkout Section -->
  <div class="container my-5">
    <h2 class="mb-4">Final Billing</h2>

    <!-- Cart Items Table -->
    <div class="mb-4">
      <h4>Cart Items</h4>
      <table class="table table-bordered">
        <thead class="table-danger">
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="cart-items">
          <!-- Items will be populated here -->
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Grand Total:</th>
            <th id="cart-total">0</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Back to Cart Button -->
    <div class="mb-4">
      <a href="index.html?openCart=true" class="btn btn-secondary"
        >&larr; Back to Cart</a
      >
    </div>

    <!-- Checkout Form -->
    <form id="checkout-form">
      <div class="mb-3">
        <label class="form-label">Full Name</label>
        <input
          type="text"
          class="form-control"
          placeholder="Enter your name"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Delivery Address</label>
        <textarea class="form-control" rows="3" required></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Phone Number</label>
        <input type="tel" class="form-control" required />
      </div>
      <div class="mb-3">
        <label class="form-label">Payment Method</label>
        <select class="form-select" required>
          <option value="">Select</option>
          <option>Cash on Delivery</option>
          <option>UPI</option>
          <option>Credit/Debit Card</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success w-100">Confirm & Pay</button>
    </form>
  </div>

  <script>
    let cart = [];

    // Load cart from localStorage
    window.addEventListener("load", () => {
      let savedCart = localStorage.getItem("cart");
      if (savedCart) cart = JSON.parse(savedCart);
      updateCartTable();
    });

    // Update the cart table and total
    function updateCartTable() {
      const tbody = document.getElementById("cart-items");
      const totalEl = document.getElementById("cart-total");
      tbody.innerHTML = "";
      let grandTotal = 0;
      cart.forEach((item) => {
        grandTotal += item.total;
        tbody.innerHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.qty}</td>
            <td>₹${item.price}</td>
            <td>₹${item.total}</td>
          </tr>
        `;
      });
      totalEl.innerText = `₹${grandTotal}`;
    }

    // Handle checkout form submission
    document
      .getElementById("checkout-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        if (cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }

        // Collect form data
        let name = document.querySelector('input[type="text"]').value;
        let address = document.querySelector("textarea").value;
        let phone = document.querySelector('input[type="tel"]').value;
        let payment = document.querySelector("select").value;
        let total = document.getElementById("cart-total").innerText;

        // Prepare order data
        let orderData = {
          name,
          address,
          phone,
          payment,
          cart,
          total,
        };

        // Send to Google Sheets Web App
        fetch(
          "https://script.google.com/macros/s/AKfycbwVernqHPXu6yDmrrtpxV_YtdWt3399ZSVEP4IWoAMB2vrQC2gVO1-bMEFQKW8maXTvng/exec",
          {
            method: "POST",
            mode: "no-cors",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData),
          }
        )
          .then(() => {
            alert("✅ Order placed successfully! Total: " + total);
            localStorage.removeItem("cart"); // Clear cart
            window.location.href = "index.html"; // Redirect back to home
          })
          .catch((err) => {
            console.error(err);
            alert("❌ Failed to place order, please try again.");
          });
      });
  </script>
</body>
</html>
